from flask import Flask, render_template, request, session, flash, redirect
from models import db, User  # 匯入資料庫和使用者模型
from auth import auth  # 匯入認證相關藍圖
from main import main  # 匯入主頁藍圖
from records import records  # 匯入記錄相關藍圖

app = Flask(__name__)

# 基本配置
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'
app.secret_key = '你的密鑰'

# 初始化資料庫
db.init_app(app)

# 註冊藍圖
app.register_blueprint(auth, url_prefix='/auth')  # 登入、註冊、登出相關
app.register_blueprint(main, url_prefix='/')  # 主頁相關
app.register_blueprint(records, url_prefix='/records')  # 健康紀錄相關

# 初始化資料庫表
with app.app_context():
    db.create_all()

# 健康建議函數
def get_health_advice(blood_pressure_in, blood_pressure_out, blood_sugar, height, weight):
    fontLargestStrong = {'blood_pressure': [], 'blood_sugar': [], 'bmi': []}
    fontSecondStrong = {'blood_pressure': [], 'blood_sugar': [], 'bmi': []}
    fontNormalStrong = {'blood_pressure': [], 'blood_sugar': [], 'bmi': []}
    fontNormal = {'blood_pressure': [], 'blood_sugar': [], 'bmi': []}

    # 血壓建議
    if blood_pressure_in is not None and blood_pressure_out is not None:
        if blood_pressure_in > 120 or blood_pressure_out > 80:
            fontLargestStrong['blood_pressure'].append("血壓太高>120/80")
            fontNormalStrong['blood_pressure'].append("建議調整飲食，低鹽飲食、多運動、減少壓力。")
        elif blood_pressure_in < 90 or blood_pressure_out < 60:
            fontLargestStrong['blood_pressure'].append("血壓太低<90/60")
            fontNormalStrong['blood_pressure'].append("建議多喝水、增加鹽分攝取，避免過度疲勞。")
        else:
            fontLargestStrong['blood_pressure'].append("血壓正常")

    # 血糖建議
    if blood_sugar is not None:
        if blood_sugar > 140:
            fontLargestStrong['blood_sugar'].append("血糖太高>140")
            fontNormalStrong['blood_sugar'].append("建議避免高糖食物，規律運動，並監控血糖。")
        elif blood_sugar < 70:
            fontLargestStrong['blood_sugar'].append("血糖太低<70")
            fontNormalStrong['blood_sugar'].append("建議多吃高纖維食物，避免空腹過久。")
        else:
            fontLargestStrong['blood_sugar'].append("血糖正常")

    # BMI 建議
    if height is not None and weight is not None:
        bmi = round(weight / (height / 100) ** 2, 2)
        if bmi >= 27:
            fontLargestStrong['bmi'].append(f"肥胖 (BMI={bmi})")
            fontNormalStrong['bmi'].append("建議減重，規律運動，控制飲食。")
        elif 24 <= bmi < 27:
            fontLargestStrong['bmi'].append(f"體重過重 (BMI={bmi})")
            fontNormalStrong['bmi'].append("建議控制熱量攝取，增加運動量。")
        elif 18.5 <= bmi < 24:
            fontLargestStrong['bmi'].append(f"正常體重 (BMI={bmi})")
            fontNormalStrong['bmi'].append("繼續保持健康的生活方式。")
        else:
            fontLargestStrong['bmi'].append(f"體重過輕 (BMI={bmi})")
            fontNormalStrong['bmi'].append("建議增加飲食熱量，適量運動以增強體質。")

    return fontLargestStrong, fontSecondStrong, fontNormalStrong, fontNormal

# 主頁面
@app.route('/', methods=['GET'])
def index():
    return render_template('index.html')

# 結果頁面
@app.route('/result', methods=['POST'])
def result():
    blood_pressure_in = float(request.form.get('blood_pressure_in', 0))
    blood_pressure_out = float(request.form.get('blood_pressure_out', 0))
    blood_sugar = float(request.form.get('blood_sugar', 0))
    height = float(request.form.get('height', 0))
    weight = float(request.form.get('weight', 0))

    advice = get_health_advice(blood_pressure_in, blood_pressure_out, blood_sugar, height, weight)
    return render_template('result.html', advice=advice)

# GI值介紹頁面
@app.route('/GI')
def GI():
    return render_template('GI.html')

# 健康資訊輸入頁面
@app.route('/info', methods=['GET', 'POST'])
def info():
    return render_template('info.html')

if __name__ == '__main__':
    app.run(debug=True)
